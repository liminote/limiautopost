# Threads 功能測試報告

## 📊 測試概覽

- **總測試數**: 42 個測試
- **通過率**: 100% ✅
- **測試文件**: 3 個
- **測試類型**: 單元測試、整合測試

## 🧪 自動化測試覆蓋範圍

### 1. Threads Service 測試 (`threadsService.test.ts`)
**測試數量**: 12 個測試

#### ✅ 已覆蓋功能
- **Threads 狀態管理**
  - 已連接狀態處理
  - 未連接狀態處理
  - 狀態同步邏輯

- **Threads 斷開連結**
  - 斷開連結成功處理
  - 斷開連結失敗處理
  - 網路錯誤處理

- **Threads 強制同步**
  - 強制同步成功
  - 同步失敗處理

- **localStorage 事件監聽**
  - localStorage 變化監聽
  - username 變化處理

- **頁面可見性變化處理**
  - 頁面變為可見
  - 頁面變為隱藏

### 2. UserSettings 組件測試 (`UserSettings.test.tsx`)
**測試數量**: 14 個測試

#### ✅ 已覆蓋功能
- **Threads 連接狀態顯示**
  - 未連接狀態顯示
  - 已連接狀態顯示
  - 已連接但無 username 狀態

- **Threads 斷開連結功能**
  - 斷開連結成功處理
  - 斷開連結失敗處理
  - 網路錯誤處理

- **Threads 強制同步功能**
  - 強制同步成功
  - 同步失敗處理

- **Threads 診斷功能**
  - 狀態診斷顯示

- **OAuth 回調處理**
  - OAuth 成功回調
  - 清除 OAuth 回調參數

- **localStorage 事件監聽**
  - localStorage 變化監聽

- **頁面可見性變化處理**
  - 頁面可見性變化

- **模板管理功能**
  - 模板管理界面

### 3. Netlify Functions 測試 (`threads-functions.test.ts`)
**測試數量**: 16 個測試

#### ✅ 已覆蓋功能
- **Threads OAuth Start Function**
  - OAuth 授權 URL 生成
  - 空用戶郵箱處理

- **Threads OAuth Callback Function**
  - state 參數解析
  - 無效 state 參數處理
  - 空 state 參數處理

- **Threads Status Function**
  - 用戶隔離 token 查詢
  - 狀態檢查邏輯
  - 錯誤狀態處理

- **Token Store Logic**
  - 用戶隔離 token key 生成
  - token 數據結構處理

- **API Response Handling**
  - Threads API 回應處理
  - API 錯誤回應處理

- **Cookie Handling**
  - 用戶隔離 cookie 生成
  - 特殊字符郵箱處理

- **Redirect URL Generation**
  - 用戶特定重定向 URL 生成
  - 無用戶郵箱重定向處理

## 🔍 需要手動測試的部分

### 1. 端到端 OAuth 流程測試
**測試場景**: 完整的 Threads 連接流程
**測試步驟**:
1. 點擊「連結 Threads（OAuth）」按鈕
2. 完成 Threads 授權
3. 檢查是否正確跳轉回設定頁面
4. 驗證狀態顯示和 username 是否正確

**預期結果**:
- OAuth 流程正常完成
- 狀態顯示「已連接」
- username 正確顯示
- 本地快取正確保存

### 2. 跨瀏覽器標籤狀態同步測試
**測試場景**: 多標籤頁狀態同步
**測試步驟**:
1. 在標籤 A 中連接 Threads
2. 在標籤 B 中打開設定頁面
3. 檢查狀態是否自動同步
4. 在標籤 B 中斷開連結
5. 檢查標籤 A 中的狀態是否更新

**預期結果**:
- 多標籤頁狀態自動同步
- localStorage 變化事件正確觸發
- 組件狀態正確更新

### 3. 網路異常情況測試
**測試場景**: 網路不穩定時的狀態管理
**測試步驟**:
1. 連接 Threads 後，模擬網路中斷
2. 嘗試斷開連結
3. 檢查錯誤處理和用戶提示
4. 網路恢復後檢查狀態同步

**預期結果**:
- 網路錯誤時顯示適當的錯誤訊息
- 錯誤狀態不會破壞本地狀態
- 網路恢復後能正確同步

### 4. 瀏覽器刷新和頁面切換測試
**測試場景**: 頁面生命週期事件處理
**測試步驟**:
1. 連接 Threads 後刷新頁面
2. 檢查狀態是否正確恢復
3. 切換到其他頁面再回來
4. 檢查狀態是否保持

**預期結果**:
- 頁面刷新後狀態正確恢復
- 頁面切換後狀態保持
- localStorage 和組件狀態一致

### 5. 多用戶隔離測試
**測試場景**: 不同用戶的 Threads 連接隔離
**測試步驟**:
1. 使用用戶 A 連接 Threads
2. 登出後使用用戶 B 登入
3. 檢查是否顯示正確的連接狀態
4. 嘗試連接 Threads，檢查是否影響用戶 A

**預期結果**:
- 不同用戶的 Threads 連接完全隔離
- 用戶 A 的連接狀態不影響用戶 B
- token 存儲使用正確的用戶前綴

### 6. 強制同步功能測試
**測試場景**: 狀態不一致時的強制同步
**測試步驟**:
1. 手動修改 localStorage 中的狀態
2. 點擊「強制同步」按鈕
3. 檢查是否從伺服器同步狀態
4. 驗證本地狀態是否更新

**預期結果**:
- 強制同步能從伺服器獲取最新狀態
- 本地狀態正確更新
- 用戶得到同步完成的提示

### 7. 診斷功能測試
**測試場景**: 狀態診斷和問題排查
**測試步驟**:
1. 點擊「診斷狀態」按鈕
2. 檢查診斷信息的準確性
3. 驗證診斷信息與實際狀態一致
4. 測試不同狀態下的診斷結果

**預期結果**:
- 診斷信息準確反映當前狀態
- 診斷結果與實際狀態一致
- 診斷信息幫助用戶理解問題

## 🚀 測試執行命令

### 運行所有 Threads 相關測試
```bash
npm run test:threads
```

### 運行單元測試
```bash
npm run test:unit
```

### 運行 Netlify Functions 測試
```bash
npm run test:netlify
```

### 運行所有測試
```bash
npm run test:run
```

### 生成測試覆蓋率報告
```bash
npm run test:coverage
```

## 📝 測試維護說明

### 添加新測試
1. 在對應的測試文件中添加新的測試用例
2. 確保測試覆蓋新的功能邏輯
3. 運行測試驗證新測試通過

### 更新現有測試
1. 當功能邏輯變更時，更新對應的測試
2. 確保測試仍然反映實際的行為
3. 運行測試驗證所有測試通過

### 測試數據管理
1. 使用 `beforeEach` 和 `afterEach` 清理測試狀態
2. 避免測試之間的狀態污染
3. 使用 mock 數據確保測試的獨立性

## 🎯 測試質量指標

- **測試覆蓋率**: 目標 > 90%
- **測試執行時間**: 目標 < 10 秒
- **測試穩定性**: 目標 100% 通過率
- **測試可維護性**: 清晰的測試結構和命名

## 🔧 故障排除

### 常見測試問題
1. **Mock 依賴問題**: 檢查 mock 是否正確設置
2. **異步測試問題**: 使用 `waitFor` 處理異步操作
3. **狀態污染問題**: 確保每個測試都有正確的清理

### 調試技巧
1. 使用 `console.log` 輸出測試狀態
2. 檢查 mock 函數的調用次數和參數
3. 驗證測試環境設置是否正確
