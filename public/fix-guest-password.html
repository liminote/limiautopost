<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復 Guest 密碼</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>修復 Guest 密碼</h1>
    
    <div class="section">
        <h2>當前 Guest 用戶資訊</h2>
        <div id="guestInfo"></div>
    </div>

    <div class="section">
        <h2>修復操作</h2>
        <button onclick="resetGuestPassword()">重置 Guest 密碼為 guest123</button>
        <button onclick="deleteGuestUser()">刪除 Guest 用戶</button>
        <button onclick="createNewGuest()">創建新的 Guest 用戶</button>
        <div id="result"></div>
    </div>

    <div class="section">
        <h2>測試登入</h2>
        <input type="password" id="testPassword" placeholder="輸入密碼測試" value="guest123">
        <button onclick="testPassword()">測試密碼</button>
        <div id="testResult"></div>
    </div>

    <script>
        function loadGuestInfo() {
            try {
                const usersData = localStorage.getItem('limiautopost:users');
                if (!usersData) {
                    document.getElementById('guestInfo').innerHTML = '<p class="error">沒有找到用戶資料</p>';
                    return;
                }
                
                const users = JSON.parse(usersData);
                const guest = users.find(u => u.email === 'guest@gmail.com');
                
                if (!guest) {
                    document.getElementById('guestInfo').innerHTML = '<p class="error">沒有找到 guest@gmail.com 用戶</p>';
                    return;
                }
                
                document.getElementById('guestInfo').innerHTML = `
                    <p><strong>Email:</strong> ${guest.email}</p>
                    <p><strong>密碼:</strong> ${guest.password}</p>
                    <p><strong>啟用:</strong> ${guest.enabled !== false ? '是' : '否'}</p>
                    <p><strong>創建時間:</strong> ${guest.createdAt}</p>
                    <p><strong>有效起訖:</strong> ${guest.validFrom || 'N/A'} ~ ${guest.validTo || 'N/A'}</p>
                    <p><strong>舊版到期:</strong> ${guest.expiresAt || 'N/A'}</p>
                `;
            } catch (e) {
                document.getElementById('guestInfo').innerHTML = `<p class="error">載入失敗: ${e.message}</p>`;
            }
        }

        function resetGuestPassword() {
            try {
                const usersData = localStorage.getItem('limiautopost:users');
                if (!usersData) {
                    document.getElementById('result').innerHTML = '<p class="error">沒有找到用戶資料</p>';
                    return;
                }
                
                const users = JSON.parse(usersData);
                const guestIndex = users.findIndex(u => u.email === 'guest@gmail.com');
                
                if (guestIndex === -1) {
                    document.getElementById('result').innerHTML = '<p class="error">沒有找到 guest@gmail.com 用戶</p>';
                    return;
                }
                
                // 重置密碼
                users[guestIndex].password = 'guest123';
                
                // 更新時間範圍
                const today = new Date();
                const nextYear = new Date(today.getFullYear() + 1, 11, 31);
                const validFrom = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                const validTo = `${nextYear.getFullYear()}-${String(nextYear.getMonth()+1).padStart(2,'0')}-${String(nextYear.getDate()).padStart(2,'0')}`;
                
                users[guestIndex].validFrom = validFrom;
                users[guestIndex].validTo = validTo;
                users[guestIndex].enabled = true;
                
                localStorage.setItem('limiautopost:users', JSON.stringify(users));
                document.getElementById('result').innerHTML = '<p class="success">Guest 密碼已重置為 guest123，時間範圍已更新</p>';
                loadGuestInfo();
            } catch (e) {
                document.getElementById('result').innerHTML = `<p class="error">重置失敗: ${e.message}</p>`;
            }
        }

        function deleteGuestUser() {
            try {
                const usersData = localStorage.getItem('limiautopost:users');
                if (!usersData) {
                    document.getElementById('result').innerHTML = '<p class="error">沒有找到用戶資料</p>';
                    return;
                }
                
                const users = JSON.parse(usersData);
                const filteredUsers = users.filter(u => u.email !== 'guest@gmail.com');
                
                localStorage.setItem('limiautopost:users', JSON.stringify(filteredUsers));
                document.getElementById('result').innerHTML = '<p class="success">Guest 用戶已刪除</p>';
                loadGuestInfo();
            } catch (e) {
                document.getElementById('result').innerHTML = `<p class="error">刪除失敗: ${e.message}</p>`;
            }
        }

        function createNewGuest() {
            try {
                const usersData = localStorage.getItem('limiautopost:users');
                const users = usersData ? JSON.parse(usersData) : [];
                
                // 先刪除現有的 guest 用戶
                const filteredUsers = users.filter(u => u.email !== 'guest@gmail.com');
                
                // 創建新的 guest 用戶
                const today = new Date();
                const nextYear = new Date(today.getFullYear() + 1, 11, 31);
                const validFrom = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                const validTo = `${nextYear.getFullYear()}-${String(nextYear.getMonth()+1).padStart(2,'0')}-${String(nextYear.getDate()).padStart(2,'0')}`;
                
                const newGuest = {
                    id: crypto.randomUUID(),
                    email: 'guest@gmail.com',
                    password: 'guest123',
                    createdAt: validFrom,
                    validFrom: validFrom,
                    validTo: validTo,
                    enabled: true,
                    mustChangePassword: false,
                    notes: ''
                };
                
                filteredUsers.unshift(newGuest);
                localStorage.setItem('limiautopost:users', JSON.stringify(filteredUsers));
                document.getElementById('result').innerHTML = '<p class="success">新的 Guest 用戶已創建</p>';
                loadGuestInfo();
            } catch (e) {
                document.getElementById('result').innerHTML = `<p class="error">創建失敗: ${e.message}</p>`;
            }
        }

        function testPassword() {
            const testPassword = document.getElementById('testPassword').value;
            
            try {
                const usersData = localStorage.getItem('limiautopost:users');
                if (!usersData) {
                    document.getElementById('testResult').innerHTML = '<p class="error">沒有找到用戶資料</p>';
                    return;
                }
                
                const users = JSON.parse(usersData);
                const guest = users.find(u => u.email === 'guest@gmail.com');
                
                if (!guest) {
                    document.getElementById('testResult').innerHTML = '<p class="error">沒有找到 guest@gmail.com 用戶</p>';
                    return;
                }
                
                if (guest.password === testPassword) {
                    document.getElementById('testResult').innerHTML = '<p class="success">密碼正確！</p>';
                } else {
                    document.getElementById('testResult').innerHTML = `<p class="error">密碼錯誤！實際密碼是: ${guest.password}</p>`;
                }
            } catch (e) {
                document.getElementById('testResult').innerHTML = `<p class="error">測試失敗: ${e.message}</p>`;
            }
        }

        // 頁面載入時自動載入資訊
        loadGuestInfo();
    </script>
</body>
</html>
