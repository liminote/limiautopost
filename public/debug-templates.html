<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統模板診斷工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 系統模板診斷工具</h1>
        
        <div class="section">
            <h2>📊 當前狀態檢查</h2>
            <button onclick="checkAllStatus()">檢查所有狀態</button>
            <button onclick="checkLocalStorage()">檢查 localStorage</button>
            <button onclick="checkSystemTemplates()">檢查系統模板</button>
            <button onclick="checkCardService()">檢查 CardService</button>
            <button onclick="startMonitoring()" class="success">開始實時監控</button>
            <button onclick="stopMonitoring()" class="warning">停止實時監控</button>
        </div>

        <div class="section">
            <h2>🛠️ 修復操作</h2>
            <button onclick="restoreSystemTemplates()" class="success">恢復系統模板</button>
            <button onclick="testTemplatePersistence()" class="success">測試模板持久化</button>
            <button onclick="detectTemplateLoss()" class="warning">檢測模板丟失</button>
            <button onclick="fixTemplateIssues()" class="success">自動修復問題</button>
            <button onclick="clearLocalStorage()" class="danger">清除 localStorage</button>
            <button onclick="resetToDefaults()" class="warning">重置為預設值</button>
        </div>

        <div class="section">
            <h2>🔬 專業系統診斷</h2>
            <button onclick="startProfessionalMonitoring()" class="success">開始專業監控</button>
            <button onclick="analyzeSystemState()" class="warning">分析系統狀態</button>
            <button onclick="traceTemplateLifecycle()" class="info">追蹤模板生命週期</button>
            <button onclick="detectHiddenIssues()" class="danger">檢測隱藏問題</button>
            <button onclick="generateSystemReport()" class="success">生成系統報告</button>
            <button onclick="checkProtectionStatus()" class="danger">檢查保護機制狀態</button>
        </div>

        <div class="section">
            <h2>📋 診斷結果</h2>
            <div id="results"></div>
               </div>
    </div>

    <script>
        // 預設系統模板
        const defaultSystemTemplates = {
            "template-1": {
                "id": "template-1",
                "platform": "threads",
                "title": "生活體悟",
                "features": "分享生活感悟、個人成長、心靈啟發",
                "prompt": "請嚴格遵守以下規則生成 Threads 第一則貼文：\n- 聚焦於一個清晰的主題（體悟、情境、對話）\n- 包含獨立完整的觀點與論述，結尾加收束句\n- 加入一個相關 hashtag（限一個）\n- 字數限制：480～500 字\n- 不能與其他貼文有上下文延續關係",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-2": {
                "id": "template-2",
                "platform": "threads",
                "title": "專業分享",
                "features": "行業見解、技能分享、專業知識",
                "prompt": "請嚴格遵守以下規則生成 Threads 第一則貼文：\n- 聚焦於一個專業主題或技能分享\n- 包含實用的建議或見解，結尾加行動呼籲\n- 加入一個相關 hashtag（限一個）\n- 字數限制：480～500 字\n- 不能與其他貼文有上下文延續關係",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-3": {
                "id": "template-3",
                "platform": "threads",
                "title": "創意故事",
                "features": "故事創作、想像力、創意表達",
                "prompt": "請嚴格遵守以下規則生成 Threads 第一則貼文：\n- 聚焦於一個創意故事或想像情境\n- 包含生動的描述和情感表達，結尾加反思\n- 加入一個相關 hashtag（限一個）\n- 字數限制：480～500 字\n- 不能與其他貼文有上下文延續關係",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-4": {
                "id": "template-4",
                "platform": "threads",
                "title": "時事評論",
                "features": "社會議題、時事分析、觀點表達",
                "prompt": "請嚴格遵守以下規則生成 Threads 第一則貼文：\n- 聚焦於一個時事議題或社會現象\n- 包含客觀分析和個人觀點，結尾加思考問題\n- 加入一個相關 hashtag（限一個）\n- 字數限制：480～500 字\n- 不能與其他貼文有上下文延續關係",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            }
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function checkAllStatus() {
            log('開始全面狀態檢查...', 'info');
            checkLocalStorage();
            checkSystemTemplates();
            checkCardService();
        }

        function checkLocalStorage() {
            log('檢查 localStorage 狀態...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                const limiautopostKeys = keys.filter(key => key.startsWith('limiautopost:'));
                
                log(`找到 ${keys.length} 個 localStorage 項目`, 'info');
                log(`其中 ${limiautopostKeys.length} 個是 limiautopost 相關`, 'info');
                
                limiautopostKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const size = value ? value.length : 0;
                        log(`${key}: ${size} 字符`, 'info');
                    } catch (e) {
                        log(`${key}: 讀取失敗 - ${e.message}`, 'error');
                    }
                });
                
                // 檢查特定項目
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (systemTemplates) {
                    try {
                        const parsed = JSON.parse(systemTemplates);
                        log(`系統模板: 找到 ${Object.keys(parsed).length} 個模板`, 'success');
                    } catch (e) {
                        log(`系統模板: JSON 解析失敗 - ${e.message}`, 'error');
                    }
                } else {
                    log('系統模板: 不存在', 'warning');
                }
                
            } catch (e) {
                log(`localStorage 檢查失敗: ${e.message}`, 'error');
            }
        }

        function checkSystemTemplates() {
            log('檢查系統模板狀態...', 'info');
            
            try {
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (systemTemplates) {
                    const parsed = JSON.parse(systemTemplates);
                    log(`✅ 系統模板存在，包含 ${Object.keys(parsed).length} 個模板`, 'success');
                    
                    Object.entries(parsed).forEach(([id, template]) => {
                        log(`模板 ${id}: ${template.title || '無標題'}`, 'info');
                    });
                } else {
                    log('❌ 系統模板不存在於 localStorage', 'error');
                }
                
                // 檢查是否有其他相關的存儲鍵
                const allKeys = Object.keys(localStorage);
                const templateKeys = allKeys.filter(key => key.includes('template') || key.includes('card'));
                if (templateKeys.length > 0) {
                    log(`找到其他模板相關鍵: ${templateKeys.join(', ')}`, 'info');
                }
                
            } catch (e) {
                log(`系統模板檢查失敗: ${e.message}`, 'error');
            }
        }

        function checkCardService() {
            log('檢查 CardService 狀態...', 'info');
            
            try {
                // 檢查是否有 CardService 實例
                if (window.CardService) {
                    log('✅ CardService 實例存在', 'success');
                } else {
                    log('❌ CardService 實例不存在', 'warning');
                }
                
                // 檢查是否有相關的事件監聽器
                if (window.addEventListener) {
                    log('✅ 事件監聽器支援正常', 'success');
                } else {
                    log('❌ 事件監聽器支援異常', 'error');
                }
                
            } catch (e) {
                log(`CardService 檢查失敗: ${e.message}`, 'error');
            }
        }

        function restoreSystemTemplates() {
            log('開始恢復系統模板...', 'info');
            
            try {
                localStorage.setItem('limiautopost:systemTemplates', JSON.stringify(defaultSystemTemplates));
                log('✅ 系統模板已恢復', 'success');
                
                // 觸發模板更新事件
                if (window.dispatchEvent) {
                    window.dispatchEvent(new Event('templatesUpdated'));
                    log('✅ 已觸發模板更新事件', 'success');
                }
                
                checkSystemTemplates();
                
            } catch (e) {
                log(`恢復系統模板失敗: ${e.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            log('開始清除 localStorage...', 'warning');
            
            try {
                const keys = Object.keys(localStorage);
                const limiautopostKeys = keys.filter(key => key.startsWith('limiautopost:'));
                
                limiautopostKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`已清除: ${key}`, 'info');
                });
                
                log(`✅ 已清除 ${limiautopostKeys.length} 個 limiautopost 相關項目`, 'success');
                
            } catch (e) {
                log(`清除 localStorage 失敗: ${e.message}`, 'error');
            }
        }

        function resetToDefaults() {
            log('重置為預設值...', 'warning');
            
            try {
                // 清除現有數據
                clearLocalStorage();
                
                // 恢復系統模板
                restoreSystemTemplates();
                
                log('✅ 已重置為預設值', 'success');
                
            } catch (e) {
                log(`重置失敗: ${e.message}`, 'error');
            }
        }

        function testTemplatePersistence() {
            log('開始測試模板持久化功能...', 'info');
            
            try {
                // 1. 檢查初始狀態
                const initialTemplates = localStorage.getItem('limiautopost:systemTemplates');
                log(`初始狀態: ${initialTemplates ? '有模板' : '無模板'}`, 'info');
                
                // 2. 模擬編輯模板
                if (initialTemplates) {
                    const templates = JSON.parse(initialTemplates);
                    const templateId = Object.keys(templates)[0];
                    
                    if (templateId) {
                        // 模擬編輯模板
                        templates[templateId].templateTitle = '測試編輯 - ' + new Date().toLocaleTimeString();
                        templates[templateId].prompt = '這是測試編輯的 prompt - ' + new Date().toLocaleTimeString();
                        templates[templateId].updatedAt = new Date().toISOString();
                        
                        // 保存編輯後的模板
                        localStorage.setItem('limiautopost:systemTemplates', JSON.stringify(templates));
                        log(`✅ 已編輯並保存模板: ${templateId}`, 'success');
                        
                        // 3. 檢查編輯是否保存成功
                        const savedTemplates = localStorage.getItem('limiautopost:systemTemplates');
                        if (savedTemplates) {
                            const saved = JSON.parse(savedTemplates);
                            const editedTemplate = saved[templateId];
                            log(`編輯後的模板標題: ${editedTemplate.templateTitle}`, 'info');
                            log(`編輯後的 prompt: ${editedTemplate.prompt}`, 'info');
                        }
                        
                        // 4. 模擬頁面重新載入（清除記憶體中的模板）
                        log('模擬頁面重新載入...', 'info');
                        
                        // 5. 檢查模板是否仍然存在
                        const reloadedTemplates = localStorage.getItem('limiautopost:systemTemplates');
                        if (reloadedTemplates) {
                            const reloaded = JSON.parse(reloadedTemplates);
                            const reloadedTemplate = reloaded[templateId];
                            if (reloadedTemplate.templateTitle.includes('測試編輯')) {
                                log('✅ 模板持久化測試成功！編輯內容在重新載入後仍然存在', 'success');
                            } else {
                                log('❌ 模板持久化測試失敗！編輯內容在重新載入後丟失', 'error');
                            }
                        } else {
                            log('❌ 模板持久化測試失敗！重新載入後找不到模板', 'error');
                        }
                    }
                } else {
                    log('❌ 無法測試：沒有找到初始模板', 'error');
                }
                
            } catch (e) {
                log(`模板持久化測試失敗: ${e.message}`, 'error');
            }
        }

        function detectTemplateLoss() {
            log('開始檢測系統模板丟失問題...', 'info');
            
            try {
                const issues = [];
                
                // 1. 檢查系統模板是否存在
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (!systemTemplates) {
                    issues.push('系統模板完全丟失');
                } else {
                    try {
                        const templates = JSON.parse(systemTemplates);
                        if (Object.keys(templates).length === 0) {
                            issues.push('系統模板為空');
                        } else {
                            log(`✅ 系統模板存在，包含 ${Object.keys(templates).length} 個模板`, 'success');
                        }
                    } catch (e) {
                        issues.push(`系統模板數據損壞: ${e.message}`);
                    }
                }
                
                // 2. 檢查舊的存儲鍵
                const oldTemplates = localStorage.getItem('aigenerator_templates');
                if (oldTemplates) {
                    issues.push('發現舊的存儲鍵 aigenerator_templates，可能導致數據不一致');
                }
                
                // 3. 檢查是否有清除操作
                const allKeys = Object.keys(localStorage);
                const limiautopostKeys = allKeys.filter(key => key.startsWith('limiautopost:'));
                if (limiautopostKeys.length === 0) {
                    issues.push('沒有找到任何 limiautopost 相關的存儲鍵');
                }
                
                // 4. 檢查瀏覽器存儲限制
                let totalSize = 0;
                try {
                    for (let key of allKeys) {
                        const value = localStorage.getItem(key);
                        if (value) totalSize += value.length;
                    }
                    if (totalSize > 5000000) { // 5MB
                        issues.push('localStorage 可能已接近容量限制');
                    }
                } catch (e) {
                    issues.push(`無法檢查存儲大小: ${e.message}`);
                }
                
                // 5. 輸出檢測結果
                if (issues.length === 0) {
                    log('✅ 未發現系統模板丟失問題', 'success');
                } else {
                    log(`❌ 發現 ${issues.length} 個問題:`, 'error');
                    issues.forEach((issue, index) => {
                        log(`${index + 1}. ${issue}`, 'error');
                    });
                }
                
                return issues;
                
            } catch (e) {
                log(`檢測失敗: ${e.message}`, 'error');
                return ['檢測過程發生錯誤'];
            }
        }

        function fixTemplateIssues() {
            log('開始自動修復系統模板問題...', 'info');
            
            try {
                // 1. 檢測問題
                const issues = detectTemplateLoss();
                
                if (issues.length === 0) {
                    log('✅ 沒有問題需要修復', 'success');
                    return;
                }
                
                // 2. 自動修復
                let fixedCount = 0;
                
                // 修復系統模板丟失
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (!systemTemplates || systemTemplates === '{}') {
                    log('修復系統模板丟失...', 'info');
                    restoreSystemTemplates();
                    fixedCount++;
                }
                
                // 清理舊的存儲鍵
                const oldTemplates = localStorage.getItem('aigenerator_templates');
                if (oldTemplates) {
                    log('清理舊的存儲鍵...', 'info');
                    localStorage.removeItem('aigenerator_templates');
                    fixedCount++;
                }
                
                // 3. 驗證修復結果
                log('驗證修復結果...', 'info');
                const remainingIssues = detectTemplateLoss();
                
                if (remainingIssues.length === 0) {
                    log(`✅ 自動修復完成！修復了 ${fixedCount} 個問題`, 'success');
                } else {
                    log(`⚠️ 部分修復完成，還有 ${remainingIssues.length} 個問題需要手動處理`, 'warning');
                    remainingIssues.forEach((issue, index) => {
                        log(`${index + 1}. ${issue}`, 'warning');
                    });
                }
                
            } catch (e) {
                log(`自動修復失敗: ${e.message}`, 'error');
            }
        }

        // 頁面載入時自動檢查
        window.addEventListener('load', () => {
            log('頁面載入完成，開始自動檢查...', 'info');
            setTimeout(checkAllStatus, 1000);
        });

        // 實時監控變數
        let monitoringInterval = null;
        let lastTemplateState = null;

        function startMonitoring() {
            if (monitoringInterval) {
                log('監控已經在運行中', 'warning');
                return;
            }
            
            log('開始實時監控系統模板狀態...', 'success');
            
            // 記錄初始狀態
            lastTemplateState = localStorage.getItem('limiautopost:systemTemplates');
            
            // 每2秒檢查一次
            monitoringInterval = setInterval(() => {
                const currentState = localStorage.getItem('limiautopost:systemTemplates');
                
                // 檢查狀態變化
                if (currentState !== lastTemplateState) {
                    if (!currentState || currentState === '{}') {
                        log('🚨 檢測到系統模板丟失！', 'error');
                        log('嘗試自動恢復...', 'info');
                        restoreSystemTemplates();
                    } else if (!lastTemplateState) {
                        log('✅ 系統模板已恢復', 'success');
                    } else {
                        log('📝 系統模板內容已更新', 'info');
                    }
                    
                    lastTemplateState = currentState;
                }
                
                // 檢查備份狀態
                const backupState = localStorage.getItem('limiautopost:systemTemplates_backup');
                if (!backupState) {
                    log('⚠️ 系統模板備份不存在，建議創建備份', 'warning');
                }
                
            }, 2000);
            
            log('實時監控已啟動，每2秒檢查一次', 'success');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('實時監控已停止', 'info');
            } else {
                log('監控未在運行', 'warning');
            }
        }

        // 監聽 localStorage 變化
        function setupLocalStorageListener() {
            const originalSetItem = localStorage.setItem;
            const originalRemoveItem = localStorage.removeItem;
            const originalClear = localStorage.clear;
            
            localStorage.setItem = function(key, value) {
                if (key === 'limiautopost:systemTemplates') {
                    log(`📝 系統模板被設置: ${value ? '有內容' : '無內容'}`, 'info');
                }
                return originalSetItem.call(this, key, value);
            };
            
            localStorage.removeItem = function(key) {
                if (key === 'limiautopost:systemTemplates') {
                    log(`🚨 嘗試清除系統模板: ${key}`, 'error');
                }
                return originalRemoveItem.call(this, key);
            };
            
            localStorage.clear = function() {
                log('🚨 嘗試清除所有 localStorage 數據', 'error');
                return originalClear.call(this);
            };
            
            log('localStorage 監聽器已設置', 'success');
        }

        // 頁面載入時設置監聽器
        window.addEventListener('load', () => {
            setupLocalStorageListener();
            enableSystemTemplateProtection(); // 啟用系統模板保護
        });

        // 系統模板保護機制
        function enableSystemTemplateProtection() {
            try {
                console.log('[Debug] 啟用系統模板保護機制...');
                
                // 保存原始方法
                const originalRemoveItem = localStorage.removeItem;
                const originalClear = localStorage.clear;
                const originalSetItem = localStorage.setItem;
                
                // 保護 removeItem
                localStorage.removeItem = function(key) {
                    if (key === 'limiautopost:systemTemplates' || key === 'aigenerator_templates') {
                        console.warn('[Debug] 保護：阻止清除系統模板:', key);
                        return;
                    }
                    return originalRemoveItem.call(localStorage, key);
                };
                
                // 保護 clear
                localStorage.clear = function() {
                    console.warn('[Debug] 保護：阻止清除所有 localStorage 數據');
                    return;
                };
                
                // 保護 setItem
                localStorage.setItem = function(key, value) {
                    if (key === 'limiautopost:systemTemplates' && (!value || value === '{}' || value === '[]')) {
                        console.warn('[Debug] 保護：阻止將系統模板設置為空值');
                        return;
                    }
                    return originalSetItem.call(localStorage, key, value);
                };
                
                // 設置保護狀態
                localStorage.setItem('limiautopost:protectionStatus', 'protected');
                localStorage.setItem('limiautopost:protectionEnabledAt', new Date().toISOString());
                
                console.log('[Debug] 系統模板保護機制已啟用');
            } catch (error) {
                console.error('[Debug] 啟用系統模板保護機制失敗:', error);
            }
        }

        // 專業系統診斷功能
        let professionalMonitoring = null;
        let systemStateHistory = [];
        let templateLifecycleEvents = [];

        function startProfessionalMonitoring() {
            if (professionalMonitoring) {
                log('專業監控已經在運行中', 'warning');
                return;
            }
            
            log('🚀 開始專業系統監控...', 'success');
            
            // 記錄初始系統狀態
            const initialState = captureSystemState();
            systemStateHistory.push({
                timestamp: new Date(),
                state: initialState,
                event: '監控開始'
            });
            
            // 每1秒進行一次深度檢查
            professionalMonitoring = setInterval(() => {
                const currentState = captureSystemState();
                const previousState = systemStateHistory[systemStateHistory.length - 1];
                
                // 檢測變化
                if (JSON.stringify(currentState) !== JSON.stringify(previousState.state)) {
                    const changes = detectStateChanges(previousState.state, currentState);
                    if (changes.length > 0) {
                        log(`🔍 檢測到系統狀態變化: ${changes.join(', ')}`, 'warning');
                        
                        // 記錄變化
                        systemStateHistory.push({
                            timestamp: new Date(),
                            state: currentState,
                            event: '狀態變化',
                            changes: changes
                        });
                        
                        // 如果系統模板丟失，立即記錄
                        if (!currentState.systemTemplates || currentState.systemTemplates === '{}') {
                            log('🚨 系統模板丟失！記錄詳細信息...', 'error');
                            recordTemplateLoss();
                        }
                    }
                }
                
                // 限制歷史記錄數量
                if (systemStateHistory.length > 100) {
                    systemStateHistory = systemStateHistory.slice(-50);
                }
                
            }, 1000);
            
            log('✅ 專業監控已啟動，每1秒檢查一次', 'success');
        }

        function captureSystemState() {
            try {
                return {
                    timestamp: new Date().toISOString(),
                    systemTemplates: localStorage.getItem('limiautopost:systemTemplates'),
                    systemTemplatesBackup: localStorage.getItem('limiautopost:systemTemplates_backup'),
                    oldTemplates: localStorage.getItem('aigenerator_templates'),
                    userSelections: localStorage.getItem('limiautopost:userSelections'),
                    users: localStorage.getItem('limiautopost:users'),
                    session: localStorage.getItem('limiautopost:session'),
                    userCards: localStorage.getItem('limiautopost:userCards'),
                    allKeys: Object.keys(localStorage),
                    documentHidden: document.hidden,
                    documentVisibilityState: document.visibilityState,
                    windowFocus: document.hasFocus(),
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    memoryInfo: performance.memory ? {
                        usedJSHeapSize: performance.memory.usedJSHeapSize,
                        totalJSHeapSize: performance.memory.totalJSHeapSize,
                        jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                    } : null
                };
            } catch (error) {
                return { error: error.message };
            }
        }

        function detectStateChanges(previousState, currentState) {
            const changes = [];
            
            if (previousState.systemTemplates !== currentState.systemTemplates) {
                changes.push('系統模板變化');
            }
            
            if (previousState.documentHidden !== currentState.documentHidden) {
                changes.push('頁面可見性變化');
            }
            
            if (previousState.windowFocus !== currentState.windowFocus) {
                changes.push('窗口焦點變化');
            }
            
            if (previousState.url !== currentState.url) {
                changes.push('URL變化');
            }
            
            return changes;
        }

        function recordTemplateLoss() {
            const lossInfo = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                systemState: captureSystemState(),
                stackTrace: new Error().stack,
                consoleLogs: [], // 可以擴展來捕獲控制台日誌
                localStorageSnapshot: {}
            };
            
            // 捕獲所有 localStorage 內容
            try {
                for (let key of Object.keys(localStorage)) {
                    lossInfo.localStorageSnapshot[key] = localStorage.getItem(key);
                }
            } catch (error) {
                lossInfo.localStorageError = error.message;
            }
            
            templateLifecycleEvents.push(lossInfo);
            log('📝 模板丟失事件已記錄', 'info');
        }

        function analyzeSystemState() {
            log('🔬 開始分析系統狀態...', 'info');
            
            const currentState = captureSystemState();
            
            // 分析系統模板狀態
            if (!currentState.systemTemplates || currentState.systemTemplates === '{}') {
                log('❌ 系統模板狀態異常：不存在或為空', 'error');
            } else {
                try {
                    const templates = JSON.parse(currentState.systemTemplates);
                    log(`✅ 系統模板狀態正常：包含 ${Object.keys(templates).length} 個模板`, 'success');
                } catch (error) {
                    log(`❌ 系統模板數據損壞：${error.message}`, 'error');
                }
            }
            
            // 分析備份狀態
            if (!currentState.systemTemplatesBackup) {
                log('⚠️ 系統模板備份不存在', 'warning');
            } else {
                log('✅ 系統模板備份存在', 'success');
            }
            
            // 分析 localStorage 狀態
            log(`📊 localStorage 總共包含 ${currentState.allKeys.length} 個鍵`, 'info');
            const limiautopostKeys = currentState.allKeys.filter(key => key.startsWith('limiautopost:'));
            log(`📊 其中 ${limiautopostKeys.length} 個是 limiautopost 相關`, 'info');
            
            // 分析頁面狀態
            log(`📱 頁面狀態：隱藏=${currentState.documentHidden}, 焦點=${currentState.windowFocus}`, 'info');
            
            // 分析瀏覽器信息
            log(`🌐 瀏覽器：${currentState.userAgent}`, 'info');
        }

        function traceTemplateLifecycle() {
            log('🔍 開始追蹤模板生命週期...', 'info');
            
            if (templateLifecycleEvents.length === 0) {
                log('📝 沒有記錄到模板生命週期事件', 'info');
                return;
            }
            
            log(`📊 總共記錄了 ${templateLifecycleEvents.length} 個事件`, 'info');
            
            templateLifecycleEvents.forEach((event, index) => {
                log(`事件 ${index + 1}: ${event.timestamp} - ${event.url}`, 'info');
                if (event.changes) {
                    log(`  變化: ${event.changes.join(', ')}`, 'warning');
                }
            });
        }

        function detectHiddenIssues() {
            log('🔍 開始檢測隱藏問題...', 'info');
            
            const issues = [];
            
            // 檢查是否有其他組件在清除數據
            const allKeys = Object.keys(localStorage);
            const suspiciousKeys = allKeys.filter(key => 
                key.includes('clear') || 
                key.includes('reset') || 
                key.includes('delete') ||
                key.includes('remove')
            );
            
            if (suspiciousKeys.length > 0) {
                issues.push(`發現可疑的 localStorage 鍵: ${suspiciousKeys.join(', ')}`);
            }
            
            // 檢查是否有過期的數據
            const oldTemplates = localStorage.getItem('aigenerator_templates');
            if (oldTemplates) {
                issues.push('發現舊的存儲鍵 aigenerator_templates，可能導致數據不一致');
            }
            
            // 檢查瀏覽器兼容性
            if (!window.localStorage) {
                issues.push('瀏覽器不支援 localStorage');
            }
            
            if (!window.JSON) {
                issues.push('瀏覽器不支援 JSON');
            }
            
            // 檢查內存使用
            if (performance.memory) {
                const memoryUsage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
                if (memoryUsage > 0.8) {
                    issues.push(`內存使用率過高: ${(memoryUsage * 100).toFixed(1)}%`);
                }
            }
            
            // 輸出檢測結果
            if (issues.length === 0) {
                log('✅ 未發現隱藏問題', 'success');
            } else {
                log(`❌ 發現 ${issues.length} 個隱藏問題:`, 'error');
                issues.forEach((issue, index) => {
                    log(`${index + 1}. ${issue}`, 'error');
                });
            }
            
            return issues;
        }

        function generateSystemReport() {
            log('📋 開始生成系統報告...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                currentState: captureSystemState(),
                systemHistory: systemStateHistory.slice(-10), // 最近10個狀態
                templateEvents: templateLifecycleEvents,
                issues: detectHiddenIssues(),
                localStorageKeys: Object.keys(localStorage),
                localStorageSize: 0
            };
            
            // 計算 localStorage 大小
            try {
                for (let key of Object.keys(localStorage)) {
                    const value = localStorage.getItem(key);
                    if (value) report.localStorageSize += value.length;
                }
            } catch (error) {
                report.localStorageSizeError = error.message;
            }
            
            // 輸出報告摘要
            log('📊 系統報告摘要:', 'info');
            log(`- 當前時間: ${report.timestamp}`, 'info');
            log(`- 頁面URL: ${report.url}`, 'info');
            log(`- localStorage 鍵數量: ${report.localStorageKeys.length}`, 'info');
            log(`- localStorage 總大小: ${report.localStorageSize} 字符`, 'info');
            log(`- 系統狀態歷史: ${report.systemHistory.length} 條記錄`, 'info');
            log(`- 模板事件: ${report.templateEvents.length} 條記錄`, 'info');
            log(`- 發現問題: ${report.issues.length} 個`, 'info');
            
            // 將完整報告保存到 localStorage 供下載
            try {
                localStorage.setItem('limiautopost:systemReport', JSON.stringify(report));
                log('✅ 系統報告已保存，可在控制台查看', 'success');
                console.log('完整系統報告:', report);
            } catch (error) {
                log(`❌ 保存系統報告失敗: ${error.message}`, 'error');
            }
        }

        function checkProtectionStatus() {
            log('檢查保護機制狀態...', 'info');
            
            try {
                const isProtected = localStorage.getItem('limiautopost:protectionStatus') === 'protected';
                const message = isProtected ? '✅ 保護機制已啟用' : '❌ 保護機制未啟用';
                log(message, isProtected ? 'success' : 'warning');

                if (!isProtected) {
                    log('🚨 建議啟用保護機制以防止數據意外丟失！', 'warning');
                    log('請在 localStorage 中設置 "limiautopost:protectionStatus": "protected"', 'info');
                }

            } catch (e) {
                log(`檢查保護機制狀態失敗: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>
