<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±æ¨¡æ¿è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç³»çµ±æ¨¡æ¿è¨ºæ–·å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸ“Š ç•¶å‰ç‹€æ…‹æª¢æŸ¥</h2>
            <button onclick="checkAllStatus()">æª¢æŸ¥æ‰€æœ‰ç‹€æ…‹</button>
            <button onclick="checkLocalStorage()">æª¢æŸ¥ localStorage</button>
            <button onclick="checkSystemTemplates()">æª¢æŸ¥ç³»çµ±æ¨¡æ¿</button>
            <button onclick="checkCardService()">æª¢æŸ¥ CardService</button>
            <button onclick="startMonitoring()" class="success">é–‹å§‹å¯¦æ™‚ç›£æ§</button>
            <button onclick="stopMonitoring()" class="warning">åœæ­¢å¯¦æ™‚ç›£æ§</button>
        </div>

        <div class="section">
            <h2>ğŸ› ï¸ ä¿®å¾©æ“ä½œ</h2>
            <button onclick="restoreSystemTemplates()" class="success">æ¢å¾©ç³»çµ±æ¨¡æ¿</button>
            <button onclick="testTemplatePersistence()" class="success">æ¸¬è©¦æ¨¡æ¿æŒä¹…åŒ–</button>
            <button onclick="detectTemplateLoss()" class="warning">æª¢æ¸¬æ¨¡æ¿ä¸Ÿå¤±</button>
            <button onclick="fixTemplateIssues()" class="success">è‡ªå‹•ä¿®å¾©å•é¡Œ</button>
            <button onclick="clearLocalStorage()" class="danger">æ¸…é™¤ localStorage</button>
            <button onclick="resetToDefaults()" class="warning">é‡ç½®ç‚ºé è¨­å€¼</button>
        </div>

        <div class="section">
            <h2>ğŸ”¬ å°ˆæ¥­ç³»çµ±è¨ºæ–·</h2>
            <button onclick="startProfessionalMonitoring()" class="success">é–‹å§‹å°ˆæ¥­ç›£æ§</button>
            <button onclick="analyzeSystemState()" class="warning">åˆ†æç³»çµ±ç‹€æ…‹</button>
            <button onclick="traceTemplateLifecycle()" class="info">è¿½è¹¤æ¨¡æ¿ç”Ÿå‘½é€±æœŸ</button>
            <button onclick="detectHiddenIssues()" class="danger">æª¢æ¸¬éš±è—å•é¡Œ</button>
            <button onclick="generateSystemReport()" class="success">ç”Ÿæˆç³»çµ±å ±å‘Š</button>
            <button onclick="checkProtectionStatus()" class="danger">æª¢æŸ¥ä¿è­·æ©Ÿåˆ¶ç‹€æ…‹</button>
        </div>

        <div class="section">
            <h2>ğŸ“‹ è¨ºæ–·çµæœ</h2>
            <div id="results"></div>
               </div>
    </div>

    <script>
        // é è¨­ç³»çµ±æ¨¡æ¿
        const defaultSystemTemplates = {
            "template-1": {
                "id": "template-1",
                "platform": "threads",
                "title": "ç”Ÿæ´»é«”æ‚Ÿ",
                "features": "åˆ†äº«ç”Ÿæ´»æ„Ÿæ‚Ÿã€å€‹äººæˆé•·ã€å¿ƒéˆå•Ÿç™¼",
                "prompt": "è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ç”Ÿæˆ Threads ç¬¬ä¸€å‰‡è²¼æ–‡ï¼š\n- èšç„¦æ–¼ä¸€å€‹æ¸…æ™°çš„ä¸»é¡Œï¼ˆé«”æ‚Ÿã€æƒ…å¢ƒã€å°è©±ï¼‰\n- åŒ…å«ç¨ç«‹å®Œæ•´çš„è§€é»èˆ‡è«–è¿°ï¼Œçµå°¾åŠ æ”¶æŸå¥\n- åŠ å…¥ä¸€å€‹ç›¸é—œ hashtagï¼ˆé™ä¸€å€‹ï¼‰\n- å­—æ•¸é™åˆ¶ï¼š480ï½500 å­—\n- ä¸èƒ½èˆ‡å…¶ä»–è²¼æ–‡æœ‰ä¸Šä¸‹æ–‡å»¶çºŒé—œä¿‚",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-2": {
                "id": "template-2",
                "platform": "threads",
                "title": "å°ˆæ¥­åˆ†äº«",
                "features": "è¡Œæ¥­è¦‹è§£ã€æŠ€èƒ½åˆ†äº«ã€å°ˆæ¥­çŸ¥è­˜",
                "prompt": "è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ç”Ÿæˆ Threads ç¬¬ä¸€å‰‡è²¼æ–‡ï¼š\n- èšç„¦æ–¼ä¸€å€‹å°ˆæ¥­ä¸»é¡Œæˆ–æŠ€èƒ½åˆ†äº«\n- åŒ…å«å¯¦ç”¨çš„å»ºè­°æˆ–è¦‹è§£ï¼Œçµå°¾åŠ è¡Œå‹•å‘¼ç±²\n- åŠ å…¥ä¸€å€‹ç›¸é—œ hashtagï¼ˆé™ä¸€å€‹ï¼‰\n- å­—æ•¸é™åˆ¶ï¼š480ï½500 å­—\n- ä¸èƒ½èˆ‡å…¶ä»–è²¼æ–‡æœ‰ä¸Šä¸‹æ–‡å»¶çºŒé—œä¿‚",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-3": {
                "id": "template-3",
                "platform": "threads",
                "title": "å‰µæ„æ•…äº‹",
                "features": "æ•…äº‹å‰µä½œã€æƒ³åƒåŠ›ã€å‰µæ„è¡¨é”",
                "prompt": "è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ç”Ÿæˆ Threads ç¬¬ä¸€å‰‡è²¼æ–‡ï¼š\n- èšç„¦æ–¼ä¸€å€‹å‰µæ„æ•…äº‹æˆ–æƒ³åƒæƒ…å¢ƒ\n- åŒ…å«ç”Ÿå‹•çš„æè¿°å’Œæƒ…æ„Ÿè¡¨é”ï¼Œçµå°¾åŠ åæ€\n- åŠ å…¥ä¸€å€‹ç›¸é—œ hashtagï¼ˆé™ä¸€å€‹ï¼‰\n- å­—æ•¸é™åˆ¶ï¼š480ï½500 å­—\n- ä¸èƒ½èˆ‡å…¶ä»–è²¼æ–‡æœ‰ä¸Šä¸‹æ–‡å»¶çºŒé—œä¿‚",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            },
            "template-4": {
                "id": "template-4",
                "platform": "threads",
                "title": "æ™‚äº‹è©•è«–",
                "features": "ç¤¾æœƒè­°é¡Œã€æ™‚äº‹åˆ†æã€è§€é»è¡¨é”",
                "prompt": "è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ç”Ÿæˆ Threads ç¬¬ä¸€å‰‡è²¼æ–‡ï¼š\n- èšç„¦æ–¼ä¸€å€‹æ™‚äº‹è­°é¡Œæˆ–ç¤¾æœƒç¾è±¡\n- åŒ…å«å®¢è§€åˆ†æå’Œå€‹äººè§€é»ï¼Œçµå°¾åŠ æ€è€ƒå•é¡Œ\n- åŠ å…¥ä¸€å€‹ç›¸é—œ hashtagï¼ˆé™ä¸€å€‹ï¼‰\n- å­—æ•¸é™åˆ¶ï¼š480ï½500 å­—\n- ä¸èƒ½èˆ‡å…¶ä»–è²¼æ–‡æœ‰ä¸Šä¸‹æ–‡å»¶çºŒé—œä¿‚",
                "updatedAt": "2025-01-19T00:00:00.000Z"
            }
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function checkAllStatus() {
            log('é–‹å§‹å…¨é¢ç‹€æ…‹æª¢æŸ¥...', 'info');
            checkLocalStorage();
            checkSystemTemplates();
            checkCardService();
        }

        function checkLocalStorage() {
            log('æª¢æŸ¥ localStorage ç‹€æ…‹...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                const limiautopostKeys = keys.filter(key => key.startsWith('limiautopost:'));
                
                log(`æ‰¾åˆ° ${keys.length} å€‹ localStorage é …ç›®`, 'info');
                log(`å…¶ä¸­ ${limiautopostKeys.length} å€‹æ˜¯ limiautopost ç›¸é—œ`, 'info');
                
                limiautopostKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const size = value ? value.length : 0;
                        log(`${key}: ${size} å­—ç¬¦`, 'info');
                    } catch (e) {
                        log(`${key}: è®€å–å¤±æ•— - ${e.message}`, 'error');
                    }
                });
                
                // æª¢æŸ¥ç‰¹å®šé …ç›®
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (systemTemplates) {
                    try {
                        const parsed = JSON.parse(systemTemplates);
                        log(`ç³»çµ±æ¨¡æ¿: æ‰¾åˆ° ${Object.keys(parsed).length} å€‹æ¨¡æ¿`, 'success');
                    } catch (e) {
                        log(`ç³»çµ±æ¨¡æ¿: JSON è§£æå¤±æ•— - ${e.message}`, 'error');
                    }
                } else {
                    log('ç³»çµ±æ¨¡æ¿: ä¸å­˜åœ¨', 'warning');
                }
                
            } catch (e) {
                log(`localStorage æª¢æŸ¥å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function checkSystemTemplates() {
            log('æª¢æŸ¥ç³»çµ±æ¨¡æ¿ç‹€æ…‹...', 'info');
            
            try {
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (systemTemplates) {
                    const parsed = JSON.parse(systemTemplates);
                    log(`âœ… ç³»çµ±æ¨¡æ¿å­˜åœ¨ï¼ŒåŒ…å« ${Object.keys(parsed).length} å€‹æ¨¡æ¿`, 'success');
                    
                    Object.entries(parsed).forEach(([id, template]) => {
                        log(`æ¨¡æ¿ ${id}: ${template.title || 'ç„¡æ¨™é¡Œ'}`, 'info');
                    });
                } else {
                    log('âŒ ç³»çµ±æ¨¡æ¿ä¸å­˜åœ¨æ–¼ localStorage', 'error');
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç›¸é—œçš„å­˜å„²éµ
                const allKeys = Object.keys(localStorage);
                const templateKeys = allKeys.filter(key => key.includes('template') || key.includes('card'));
                if (templateKeys.length > 0) {
                    log(`æ‰¾åˆ°å…¶ä»–æ¨¡æ¿ç›¸é—œéµ: ${templateKeys.join(', ')}`, 'info');
                }
                
            } catch (e) {
                log(`ç³»çµ±æ¨¡æ¿æª¢æŸ¥å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function checkCardService() {
            log('æª¢æŸ¥ CardService ç‹€æ…‹...', 'info');
            
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰ CardService å¯¦ä¾‹
                if (window.CardService) {
                    log('âœ… CardService å¯¦ä¾‹å­˜åœ¨', 'success');
                } else {
                    log('âŒ CardService å¯¦ä¾‹ä¸å­˜åœ¨', 'warning');
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸é—œçš„äº‹ä»¶ç›£è½å™¨
                if (window.addEventListener) {
                    log('âœ… äº‹ä»¶ç›£è½å™¨æ”¯æ´æ­£å¸¸', 'success');
                } else {
                    log('âŒ äº‹ä»¶ç›£è½å™¨æ”¯æ´ç•°å¸¸', 'error');
                }
                
            } catch (e) {
                log(`CardService æª¢æŸ¥å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function restoreSystemTemplates() {
            log('é–‹å§‹æ¢å¾©ç³»çµ±æ¨¡æ¿...', 'info');
            
            try {
                localStorage.setItem('limiautopost:systemTemplates', JSON.stringify(defaultSystemTemplates));
                log('âœ… ç³»çµ±æ¨¡æ¿å·²æ¢å¾©', 'success');
                
                // è§¸ç™¼æ¨¡æ¿æ›´æ–°äº‹ä»¶
                if (window.dispatchEvent) {
                    window.dispatchEvent(new Event('templatesUpdated'));
                    log('âœ… å·²è§¸ç™¼æ¨¡æ¿æ›´æ–°äº‹ä»¶', 'success');
                }
                
                checkSystemTemplates();
                
            } catch (e) {
                log(`æ¢å¾©ç³»çµ±æ¨¡æ¿å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            log('é–‹å§‹æ¸…é™¤ localStorage...', 'warning');
            
            try {
                const keys = Object.keys(localStorage);
                const limiautopostKeys = keys.filter(key => key.startsWith('limiautopost:'));
                
                limiautopostKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`å·²æ¸…é™¤: ${key}`, 'info');
                });
                
                log(`âœ… å·²æ¸…é™¤ ${limiautopostKeys.length} å€‹ limiautopost ç›¸é—œé …ç›®`, 'success');
                
            } catch (e) {
                log(`æ¸…é™¤ localStorage å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function resetToDefaults() {
            log('é‡ç½®ç‚ºé è¨­å€¼...', 'warning');
            
            try {
                // æ¸…é™¤ç¾æœ‰æ•¸æ“š
                clearLocalStorage();
                
                // æ¢å¾©ç³»çµ±æ¨¡æ¿
                restoreSystemTemplates();
                
                log('âœ… å·²é‡ç½®ç‚ºé è¨­å€¼', 'success');
                
            } catch (e) {
                log(`é‡ç½®å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function testTemplatePersistence() {
            log('é–‹å§‹æ¸¬è©¦æ¨¡æ¿æŒä¹…åŒ–åŠŸèƒ½...', 'info');
            
            try {
                // 1. æª¢æŸ¥åˆå§‹ç‹€æ…‹
                const initialTemplates = localStorage.getItem('limiautopost:systemTemplates');
                log(`åˆå§‹ç‹€æ…‹: ${initialTemplates ? 'æœ‰æ¨¡æ¿' : 'ç„¡æ¨¡æ¿'}`, 'info');
                
                // 2. æ¨¡æ“¬ç·¨è¼¯æ¨¡æ¿
                if (initialTemplates) {
                    const templates = JSON.parse(initialTemplates);
                    const templateId = Object.keys(templates)[0];
                    
                    if (templateId) {
                        // æ¨¡æ“¬ç·¨è¼¯æ¨¡æ¿
                        templates[templateId].templateTitle = 'æ¸¬è©¦ç·¨è¼¯ - ' + new Date().toLocaleTimeString();
                        templates[templateId].prompt = 'é€™æ˜¯æ¸¬è©¦ç·¨è¼¯çš„ prompt - ' + new Date().toLocaleTimeString();
                        templates[templateId].updatedAt = new Date().toISOString();
                        
                        // ä¿å­˜ç·¨è¼¯å¾Œçš„æ¨¡æ¿
                        localStorage.setItem('limiautopost:systemTemplates', JSON.stringify(templates));
                        log(`âœ… å·²ç·¨è¼¯ä¸¦ä¿å­˜æ¨¡æ¿: ${templateId}`, 'success');
                        
                        // 3. æª¢æŸ¥ç·¨è¼¯æ˜¯å¦ä¿å­˜æˆåŠŸ
                        const savedTemplates = localStorage.getItem('limiautopost:systemTemplates');
                        if (savedTemplates) {
                            const saved = JSON.parse(savedTemplates);
                            const editedTemplate = saved[templateId];
                            log(`ç·¨è¼¯å¾Œçš„æ¨¡æ¿æ¨™é¡Œ: ${editedTemplate.templateTitle}`, 'info');
                            log(`ç·¨è¼¯å¾Œçš„ prompt: ${editedTemplate.prompt}`, 'info');
                        }
                        
                        // 4. æ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥ï¼ˆæ¸…é™¤è¨˜æ†¶é«”ä¸­çš„æ¨¡æ¿ï¼‰
                        log('æ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥...', 'info');
                        
                        // 5. æª¢æŸ¥æ¨¡æ¿æ˜¯å¦ä»ç„¶å­˜åœ¨
                        const reloadedTemplates = localStorage.getItem('limiautopost:systemTemplates');
                        if (reloadedTemplates) {
                            const reloaded = JSON.parse(reloadedTemplates);
                            const reloadedTemplate = reloaded[templateId];
                            if (reloadedTemplate.templateTitle.includes('æ¸¬è©¦ç·¨è¼¯')) {
                                log('âœ… æ¨¡æ¿æŒä¹…åŒ–æ¸¬è©¦æˆåŠŸï¼ç·¨è¼¯å…§å®¹åœ¨é‡æ–°è¼‰å…¥å¾Œä»ç„¶å­˜åœ¨', 'success');
                            } else {
                                log('âŒ æ¨¡æ¿æŒä¹…åŒ–æ¸¬è©¦å¤±æ•—ï¼ç·¨è¼¯å…§å®¹åœ¨é‡æ–°è¼‰å…¥å¾Œä¸Ÿå¤±', 'error');
                            }
                        } else {
                            log('âŒ æ¨¡æ¿æŒä¹…åŒ–æ¸¬è©¦å¤±æ•—ï¼é‡æ–°è¼‰å…¥å¾Œæ‰¾ä¸åˆ°æ¨¡æ¿', 'error');
                        }
                    }
                } else {
                    log('âŒ ç„¡æ³•æ¸¬è©¦ï¼šæ²’æœ‰æ‰¾åˆ°åˆå§‹æ¨¡æ¿', 'error');
                }
                
            } catch (e) {
                log(`æ¨¡æ¿æŒä¹…åŒ–æ¸¬è©¦å¤±æ•—: ${e.message}`, 'error');
            }
        }

        function detectTemplateLoss() {
            log('é–‹å§‹æª¢æ¸¬ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±å•é¡Œ...', 'info');
            
            try {
                const issues = [];
                
                // 1. æª¢æŸ¥ç³»çµ±æ¨¡æ¿æ˜¯å¦å­˜åœ¨
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (!systemTemplates) {
                    issues.push('ç³»çµ±æ¨¡æ¿å®Œå…¨ä¸Ÿå¤±');
                } else {
                    try {
                        const templates = JSON.parse(systemTemplates);
                        if (Object.keys(templates).length === 0) {
                            issues.push('ç³»çµ±æ¨¡æ¿ç‚ºç©º');
                        } else {
                            log(`âœ… ç³»çµ±æ¨¡æ¿å­˜åœ¨ï¼ŒåŒ…å« ${Object.keys(templates).length} å€‹æ¨¡æ¿`, 'success');
                        }
                    } catch (e) {
                        issues.push(`ç³»çµ±æ¨¡æ¿æ•¸æ“šæå£: ${e.message}`);
                    }
                }
                
                // 2. æª¢æŸ¥èˆŠçš„å­˜å„²éµ
                const oldTemplates = localStorage.getItem('aigenerator_templates');
                if (oldTemplates) {
                    issues.push('ç™¼ç¾èˆŠçš„å­˜å„²éµ aigenerator_templatesï¼Œå¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´');
                }
                
                // 3. æª¢æŸ¥æ˜¯å¦æœ‰æ¸…é™¤æ“ä½œ
                const allKeys = Object.keys(localStorage);
                const limiautopostKeys = allKeys.filter(key => key.startsWith('limiautopost:'));
                if (limiautopostKeys.length === 0) {
                    issues.push('æ²’æœ‰æ‰¾åˆ°ä»»ä½• limiautopost ç›¸é—œçš„å­˜å„²éµ');
                }
                
                // 4. æª¢æŸ¥ç€è¦½å™¨å­˜å„²é™åˆ¶
                let totalSize = 0;
                try {
                    for (let key of allKeys) {
                        const value = localStorage.getItem(key);
                        if (value) totalSize += value.length;
                    }
                    if (totalSize > 5000000) { // 5MB
                        issues.push('localStorage å¯èƒ½å·²æ¥è¿‘å®¹é‡é™åˆ¶');
                    }
                } catch (e) {
                    issues.push(`ç„¡æ³•æª¢æŸ¥å­˜å„²å¤§å°: ${e.message}`);
                }
                
                // 5. è¼¸å‡ºæª¢æ¸¬çµæœ
                if (issues.length === 0) {
                    log('âœ… æœªç™¼ç¾ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±å•é¡Œ', 'success');
                } else {
                    log(`âŒ ç™¼ç¾ ${issues.length} å€‹å•é¡Œ:`, 'error');
                    issues.forEach((issue, index) => {
                        log(`${index + 1}. ${issue}`, 'error');
                    });
                }
                
                return issues;
                
            } catch (e) {
                log(`æª¢æ¸¬å¤±æ•—: ${e.message}`, 'error');
                return ['æª¢æ¸¬éç¨‹ç™¼ç”ŸéŒ¯èª¤'];
            }
        }

        function fixTemplateIssues() {
            log('é–‹å§‹è‡ªå‹•ä¿®å¾©ç³»çµ±æ¨¡æ¿å•é¡Œ...', 'info');
            
            try {
                // 1. æª¢æ¸¬å•é¡Œ
                const issues = detectTemplateLoss();
                
                if (issues.length === 0) {
                    log('âœ… æ²’æœ‰å•é¡Œéœ€è¦ä¿®å¾©', 'success');
                    return;
                }
                
                // 2. è‡ªå‹•ä¿®å¾©
                let fixedCount = 0;
                
                // ä¿®å¾©ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±
                const systemTemplates = localStorage.getItem('limiautopost:systemTemplates');
                if (!systemTemplates || systemTemplates === '{}') {
                    log('ä¿®å¾©ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±...', 'info');
                    restoreSystemTemplates();
                    fixedCount++;
                }
                
                // æ¸…ç†èˆŠçš„å­˜å„²éµ
                const oldTemplates = localStorage.getItem('aigenerator_templates');
                if (oldTemplates) {
                    log('æ¸…ç†èˆŠçš„å­˜å„²éµ...', 'info');
                    localStorage.removeItem('aigenerator_templates');
                    fixedCount++;
                }
                
                // 3. é©—è­‰ä¿®å¾©çµæœ
                log('é©—è­‰ä¿®å¾©çµæœ...', 'info');
                const remainingIssues = detectTemplateLoss();
                
                if (remainingIssues.length === 0) {
                    log(`âœ… è‡ªå‹•ä¿®å¾©å®Œæˆï¼ä¿®å¾©äº† ${fixedCount} å€‹å•é¡Œ`, 'success');
                } else {
                    log(`âš ï¸ éƒ¨åˆ†ä¿®å¾©å®Œæˆï¼Œé‚„æœ‰ ${remainingIssues.length} å€‹å•é¡Œéœ€è¦æ‰‹å‹•è™•ç†`, 'warning');
                    remainingIssues.forEach((issue, index) => {
                        log(`${index + 1}. ${issue}`, 'warning');
                    });
                }
                
            } catch (e) {
                log(`è‡ªå‹•ä¿®å¾©å¤±æ•—: ${e.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è‡ªå‹•æª¢æŸ¥...', 'info');
            setTimeout(checkAllStatus, 1000);
        });

        // å¯¦æ™‚ç›£æ§è®Šæ•¸
        let monitoringInterval = null;
        let lastTemplateState = null;

        function startMonitoring() {
            if (monitoringInterval) {
                log('ç›£æ§å·²ç¶“åœ¨é‹è¡Œä¸­', 'warning');
                return;
            }
            
            log('é–‹å§‹å¯¦æ™‚ç›£æ§ç³»çµ±æ¨¡æ¿ç‹€æ…‹...', 'success');
            
            // è¨˜éŒ„åˆå§‹ç‹€æ…‹
            lastTemplateState = localStorage.getItem('limiautopost:systemTemplates');
            
            // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡
            monitoringInterval = setInterval(() => {
                const currentState = localStorage.getItem('limiautopost:systemTemplates');
                
                // æª¢æŸ¥ç‹€æ…‹è®ŠåŒ–
                if (currentState !== lastTemplateState) {
                    if (!currentState || currentState === '{}') {
                        log('ğŸš¨ æª¢æ¸¬åˆ°ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±ï¼', 'error');
                        log('å˜—è©¦è‡ªå‹•æ¢å¾©...', 'info');
                        restoreSystemTemplates();
                    } else if (!lastTemplateState) {
                        log('âœ… ç³»çµ±æ¨¡æ¿å·²æ¢å¾©', 'success');
                    } else {
                        log('ğŸ“ ç³»çµ±æ¨¡æ¿å…§å®¹å·²æ›´æ–°', 'info');
                    }
                    
                    lastTemplateState = currentState;
                }
                
                // æª¢æŸ¥å‚™ä»½ç‹€æ…‹
                const backupState = localStorage.getItem('limiautopost:systemTemplates_backup');
                if (!backupState) {
                    log('âš ï¸ ç³»çµ±æ¨¡æ¿å‚™ä»½ä¸å­˜åœ¨ï¼Œå»ºè­°å‰µå»ºå‚™ä»½', 'warning');
                }
                
            }, 2000);
            
            log('å¯¦æ™‚ç›£æ§å·²å•Ÿå‹•ï¼Œæ¯2ç§’æª¢æŸ¥ä¸€æ¬¡', 'success');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('å¯¦æ™‚ç›£æ§å·²åœæ­¢', 'info');
            } else {
                log('ç›£æ§æœªåœ¨é‹è¡Œ', 'warning');
            }
        }

        // ç›£è½ localStorage è®ŠåŒ–
        function setupLocalStorageListener() {
            const originalSetItem = localStorage.setItem;
            const originalRemoveItem = localStorage.removeItem;
            const originalClear = localStorage.clear;
            
            localStorage.setItem = function(key, value) {
                if (key === 'limiautopost:systemTemplates') {
                    log(`ğŸ“ ç³»çµ±æ¨¡æ¿è¢«è¨­ç½®: ${value ? 'æœ‰å…§å®¹' : 'ç„¡å…§å®¹'}`, 'info');
                }
                return originalSetItem.call(this, key, value);
            };
            
            localStorage.removeItem = function(key) {
                if (key === 'limiautopost:systemTemplates') {
                    log(`ğŸš¨ å˜—è©¦æ¸…é™¤ç³»çµ±æ¨¡æ¿: ${key}`, 'error');
                }
                return originalRemoveItem.call(this, key);
            };
            
            localStorage.clear = function() {
                log('ğŸš¨ å˜—è©¦æ¸…é™¤æ‰€æœ‰ localStorage æ•¸æ“š', 'error');
                return originalClear.call(this);
            };
            
            log('localStorage ç›£è½å™¨å·²è¨­ç½®', 'success');
        }

        // é é¢è¼‰å…¥æ™‚è¨­ç½®ç›£è½å™¨
        window.addEventListener('load', () => {
            setupLocalStorageListener();
            enableSystemTemplateProtection(); // å•Ÿç”¨ç³»çµ±æ¨¡æ¿ä¿è­·
        });

        // ç³»çµ±æ¨¡æ¿ä¿è­·æ©Ÿåˆ¶
        function enableSystemTemplateProtection() {
            try {
                console.log('[Debug] å•Ÿç”¨ç³»çµ±æ¨¡æ¿ä¿è­·æ©Ÿåˆ¶...');
                
                // ä¿å­˜åŸå§‹æ–¹æ³•
                const originalRemoveItem = localStorage.removeItem;
                const originalClear = localStorage.clear;
                const originalSetItem = localStorage.setItem;
                
                // ä¿è­· removeItem
                localStorage.removeItem = function(key) {
                    if (key === 'limiautopost:systemTemplates' || key === 'aigenerator_templates') {
                        console.warn('[Debug] ä¿è­·ï¼šé˜»æ­¢æ¸…é™¤ç³»çµ±æ¨¡æ¿:', key);
                        return;
                    }
                    return originalRemoveItem.call(localStorage, key);
                };
                
                // ä¿è­· clear
                localStorage.clear = function() {
                    console.warn('[Debug] ä¿è­·ï¼šé˜»æ­¢æ¸…é™¤æ‰€æœ‰ localStorage æ•¸æ“š');
                    return;
                };
                
                // ä¿è­· setItem
                localStorage.setItem = function(key, value) {
                    if (key === 'limiautopost:systemTemplates' && (!value || value === '{}' || value === '[]')) {
                        console.warn('[Debug] ä¿è­·ï¼šé˜»æ­¢å°‡ç³»çµ±æ¨¡æ¿è¨­ç½®ç‚ºç©ºå€¼');
                        return;
                    }
                    return originalSetItem.call(localStorage, key, value);
                };
                
                // è¨­ç½®ä¿è­·ç‹€æ…‹
                localStorage.setItem('limiautopost:protectionStatus', 'protected');
                localStorage.setItem('limiautopost:protectionEnabledAt', new Date().toISOString());
                
                console.log('[Debug] ç³»çµ±æ¨¡æ¿ä¿è­·æ©Ÿåˆ¶å·²å•Ÿç”¨');
            } catch (error) {
                console.error('[Debug] å•Ÿç”¨ç³»çµ±æ¨¡æ¿ä¿è­·æ©Ÿåˆ¶å¤±æ•—:', error);
            }
        }

        // å°ˆæ¥­ç³»çµ±è¨ºæ–·åŠŸèƒ½
        let professionalMonitoring = null;
        let systemStateHistory = [];
        let templateLifecycleEvents = [];

        function startProfessionalMonitoring() {
            if (professionalMonitoring) {
                log('å°ˆæ¥­ç›£æ§å·²ç¶“åœ¨é‹è¡Œä¸­', 'warning');
                return;
            }
            
            log('ğŸš€ é–‹å§‹å°ˆæ¥­ç³»çµ±ç›£æ§...', 'success');
            
            // è¨˜éŒ„åˆå§‹ç³»çµ±ç‹€æ…‹
            const initialState = captureSystemState();
            systemStateHistory.push({
                timestamp: new Date(),
                state: initialState,
                event: 'ç›£æ§é–‹å§‹'
            });
            
            // æ¯1ç§’é€²è¡Œä¸€æ¬¡æ·±åº¦æª¢æŸ¥
            professionalMonitoring = setInterval(() => {
                const currentState = captureSystemState();
                const previousState = systemStateHistory[systemStateHistory.length - 1];
                
                // æª¢æ¸¬è®ŠåŒ–
                if (JSON.stringify(currentState) !== JSON.stringify(previousState.state)) {
                    const changes = detectStateChanges(previousState.state, currentState);
                    if (changes.length > 0) {
                        log(`ğŸ” æª¢æ¸¬åˆ°ç³»çµ±ç‹€æ…‹è®ŠåŒ–: ${changes.join(', ')}`, 'warning');
                        
                        // è¨˜éŒ„è®ŠåŒ–
                        systemStateHistory.push({
                            timestamp: new Date(),
                            state: currentState,
                            event: 'ç‹€æ…‹è®ŠåŒ–',
                            changes: changes
                        });
                        
                        // å¦‚æœç³»çµ±æ¨¡æ¿ä¸Ÿå¤±ï¼Œç«‹å³è¨˜éŒ„
                        if (!currentState.systemTemplates || currentState.systemTemplates === '{}') {
                            log('ğŸš¨ ç³»çµ±æ¨¡æ¿ä¸Ÿå¤±ï¼è¨˜éŒ„è©³ç´°ä¿¡æ¯...', 'error');
                            recordTemplateLoss();
                        }
                    }
                }
                
                // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
                if (systemStateHistory.length > 100) {
                    systemStateHistory = systemStateHistory.slice(-50);
                }
                
            }, 1000);
            
            log('âœ… å°ˆæ¥­ç›£æ§å·²å•Ÿå‹•ï¼Œæ¯1ç§’æª¢æŸ¥ä¸€æ¬¡', 'success');
        }

        function captureSystemState() {
            try {
                return {
                    timestamp: new Date().toISOString(),
                    systemTemplates: localStorage.getItem('limiautopost:systemTemplates'),
                    systemTemplatesBackup: localStorage.getItem('limiautopost:systemTemplates_backup'),
                    oldTemplates: localStorage.getItem('aigenerator_templates'),
                    userSelections: localStorage.getItem('limiautopost:userSelections'),
                    users: localStorage.getItem('limiautopost:users'),
                    session: localStorage.getItem('limiautopost:session'),
                    userCards: localStorage.getItem('limiautopost:userCards'),
                    allKeys: Object.keys(localStorage),
                    documentHidden: document.hidden,
                    documentVisibilityState: document.visibilityState,
                    windowFocus: document.hasFocus(),
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    memoryInfo: performance.memory ? {
                        usedJSHeapSize: performance.memory.usedJSHeapSize,
                        totalJSHeapSize: performance.memory.totalJSHeapSize,
                        jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                    } : null
                };
            } catch (error) {
                return { error: error.message };
            }
        }

        function detectStateChanges(previousState, currentState) {
            const changes = [];
            
            if (previousState.systemTemplates !== currentState.systemTemplates) {
                changes.push('ç³»çµ±æ¨¡æ¿è®ŠåŒ–');
            }
            
            if (previousState.documentHidden !== currentState.documentHidden) {
                changes.push('é é¢å¯è¦‹æ€§è®ŠåŒ–');
            }
            
            if (previousState.windowFocus !== currentState.windowFocus) {
                changes.push('çª—å£ç„¦é»è®ŠåŒ–');
            }
            
            if (previousState.url !== currentState.url) {
                changes.push('URLè®ŠåŒ–');
            }
            
            return changes;
        }

        function recordTemplateLoss() {
            const lossInfo = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                systemState: captureSystemState(),
                stackTrace: new Error().stack,
                consoleLogs: [], // å¯ä»¥æ“´å±•ä¾†æ•ç²æ§åˆ¶å°æ—¥èªŒ
                localStorageSnapshot: {}
            };
            
            // æ•ç²æ‰€æœ‰ localStorage å…§å®¹
            try {
                for (let key of Object.keys(localStorage)) {
                    lossInfo.localStorageSnapshot[key] = localStorage.getItem(key);
                }
            } catch (error) {
                lossInfo.localStorageError = error.message;
            }
            
            templateLifecycleEvents.push(lossInfo);
            log('ğŸ“ æ¨¡æ¿ä¸Ÿå¤±äº‹ä»¶å·²è¨˜éŒ„', 'info');
        }

        function analyzeSystemState() {
            log('ğŸ”¬ é–‹å§‹åˆ†æç³»çµ±ç‹€æ…‹...', 'info');
            
            const currentState = captureSystemState();
            
            // åˆ†æç³»çµ±æ¨¡æ¿ç‹€æ…‹
            if (!currentState.systemTemplates || currentState.systemTemplates === '{}') {
                log('âŒ ç³»çµ±æ¨¡æ¿ç‹€æ…‹ç•°å¸¸ï¼šä¸å­˜åœ¨æˆ–ç‚ºç©º', 'error');
            } else {
                try {
                    const templates = JSON.parse(currentState.systemTemplates);
                    log(`âœ… ç³»çµ±æ¨¡æ¿ç‹€æ…‹æ­£å¸¸ï¼šåŒ…å« ${Object.keys(templates).length} å€‹æ¨¡æ¿`, 'success');
                } catch (error) {
                    log(`âŒ ç³»çµ±æ¨¡æ¿æ•¸æ“šæå£ï¼š${error.message}`, 'error');
                }
            }
            
            // åˆ†æå‚™ä»½ç‹€æ…‹
            if (!currentState.systemTemplatesBackup) {
                log('âš ï¸ ç³»çµ±æ¨¡æ¿å‚™ä»½ä¸å­˜åœ¨', 'warning');
            } else {
                log('âœ… ç³»çµ±æ¨¡æ¿å‚™ä»½å­˜åœ¨', 'success');
            }
            
            // åˆ†æ localStorage ç‹€æ…‹
            log(`ğŸ“Š localStorage ç¸½å…±åŒ…å« ${currentState.allKeys.length} å€‹éµ`, 'info');
            const limiautopostKeys = currentState.allKeys.filter(key => key.startsWith('limiautopost:'));
            log(`ğŸ“Š å…¶ä¸­ ${limiautopostKeys.length} å€‹æ˜¯ limiautopost ç›¸é—œ`, 'info');
            
            // åˆ†æé é¢ç‹€æ…‹
            log(`ğŸ“± é é¢ç‹€æ…‹ï¼šéš±è—=${currentState.documentHidden}, ç„¦é»=${currentState.windowFocus}`, 'info');
            
            // åˆ†æç€è¦½å™¨ä¿¡æ¯
            log(`ğŸŒ ç€è¦½å™¨ï¼š${currentState.userAgent}`, 'info');
        }

        function traceTemplateLifecycle() {
            log('ğŸ” é–‹å§‹è¿½è¹¤æ¨¡æ¿ç”Ÿå‘½é€±æœŸ...', 'info');
            
            if (templateLifecycleEvents.length === 0) {
                log('ğŸ“ æ²’æœ‰è¨˜éŒ„åˆ°æ¨¡æ¿ç”Ÿå‘½é€±æœŸäº‹ä»¶', 'info');
                return;
            }
            
            log(`ğŸ“Š ç¸½å…±è¨˜éŒ„äº† ${templateLifecycleEvents.length} å€‹äº‹ä»¶`, 'info');
            
            templateLifecycleEvents.forEach((event, index) => {
                log(`äº‹ä»¶ ${index + 1}: ${event.timestamp} - ${event.url}`, 'info');
                if (event.changes) {
                    log(`  è®ŠåŒ–: ${event.changes.join(', ')}`, 'warning');
                }
            });
        }

        function detectHiddenIssues() {
            log('ğŸ” é–‹å§‹æª¢æ¸¬éš±è—å•é¡Œ...', 'info');
            
            const issues = [];
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–çµ„ä»¶åœ¨æ¸…é™¤æ•¸æ“š
            const allKeys = Object.keys(localStorage);
            const suspiciousKeys = allKeys.filter(key => 
                key.includes('clear') || 
                key.includes('reset') || 
                key.includes('delete') ||
                key.includes('remove')
            );
            
            if (suspiciousKeys.length > 0) {
                issues.push(`ç™¼ç¾å¯ç–‘çš„ localStorage éµ: ${suspiciousKeys.join(', ')}`);
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰éæœŸçš„æ•¸æ“š
            const oldTemplates = localStorage.getItem('aigenerator_templates');
            if (oldTemplates) {
                issues.push('ç™¼ç¾èˆŠçš„å­˜å„²éµ aigenerator_templatesï¼Œå¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´');
            }
            
            // æª¢æŸ¥ç€è¦½å™¨å…¼å®¹æ€§
            if (!window.localStorage) {
                issues.push('ç€è¦½å™¨ä¸æ”¯æ´ localStorage');
            }
            
            if (!window.JSON) {
                issues.push('ç€è¦½å™¨ä¸æ”¯æ´ JSON');
            }
            
            // æª¢æŸ¥å…§å­˜ä½¿ç”¨
            if (performance.memory) {
                const memoryUsage = performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit;
                if (memoryUsage > 0.8) {
                    issues.push(`å…§å­˜ä½¿ç”¨ç‡éé«˜: ${(memoryUsage * 100).toFixed(1)}%`);
                }
            }
            
            // è¼¸å‡ºæª¢æ¸¬çµæœ
            if (issues.length === 0) {
                log('âœ… æœªç™¼ç¾éš±è—å•é¡Œ', 'success');
            } else {
                log(`âŒ ç™¼ç¾ ${issues.length} å€‹éš±è—å•é¡Œ:`, 'error');
                issues.forEach((issue, index) => {
                    log(`${index + 1}. ${issue}`, 'error');
                });
            }
            
            return issues;
        }

        function generateSystemReport() {
            log('ğŸ“‹ é–‹å§‹ç”Ÿæˆç³»çµ±å ±å‘Š...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                currentState: captureSystemState(),
                systemHistory: systemStateHistory.slice(-10), // æœ€è¿‘10å€‹ç‹€æ…‹
                templateEvents: templateLifecycleEvents,
                issues: detectHiddenIssues(),
                localStorageKeys: Object.keys(localStorage),
                localStorageSize: 0
            };
            
            // è¨ˆç®— localStorage å¤§å°
            try {
                for (let key of Object.keys(localStorage)) {
                    const value = localStorage.getItem(key);
                    if (value) report.localStorageSize += value.length;
                }
            } catch (error) {
                report.localStorageSizeError = error.message;
            }
            
            // è¼¸å‡ºå ±å‘Šæ‘˜è¦
            log('ğŸ“Š ç³»çµ±å ±å‘Šæ‘˜è¦:', 'info');
            log(`- ç•¶å‰æ™‚é–“: ${report.timestamp}`, 'info');
            log(`- é é¢URL: ${report.url}`, 'info');
            log(`- localStorage éµæ•¸é‡: ${report.localStorageKeys.length}`, 'info');
            log(`- localStorage ç¸½å¤§å°: ${report.localStorageSize} å­—ç¬¦`, 'info');
            log(`- ç³»çµ±ç‹€æ…‹æ­·å²: ${report.systemHistory.length} æ¢è¨˜éŒ„`, 'info');
            log(`- æ¨¡æ¿äº‹ä»¶: ${report.templateEvents.length} æ¢è¨˜éŒ„`, 'info');
            log(`- ç™¼ç¾å•é¡Œ: ${report.issues.length} å€‹`, 'info');
            
            // å°‡å®Œæ•´å ±å‘Šä¿å­˜åˆ° localStorage ä¾›ä¸‹è¼‰
            try {
                localStorage.setItem('limiautopost:systemReport', JSON.stringify(report));
                log('âœ… ç³»çµ±å ±å‘Šå·²ä¿å­˜ï¼Œå¯åœ¨æ§åˆ¶å°æŸ¥çœ‹', 'success');
                console.log('å®Œæ•´ç³»çµ±å ±å‘Š:', report);
            } catch (error) {
                log(`âŒ ä¿å­˜ç³»çµ±å ±å‘Šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        function checkProtectionStatus() {
            log('æª¢æŸ¥ä¿è­·æ©Ÿåˆ¶ç‹€æ…‹...', 'info');
            
            try {
                const isProtected = localStorage.getItem('limiautopost:protectionStatus') === 'protected';
                const message = isProtected ? 'âœ… ä¿è­·æ©Ÿåˆ¶å·²å•Ÿç”¨' : 'âŒ ä¿è­·æ©Ÿåˆ¶æœªå•Ÿç”¨';
                log(message, isProtected ? 'success' : 'warning');

                if (!isProtected) {
                    log('ğŸš¨ å»ºè­°å•Ÿç”¨ä¿è­·æ©Ÿåˆ¶ä»¥é˜²æ­¢æ•¸æ“šæ„å¤–ä¸Ÿå¤±ï¼', 'warning');
                    log('è«‹åœ¨ localStorage ä¸­è¨­ç½® "limiautopost:protectionStatus": "protected"', 'info');
                }

            } catch (e) {
                log(`æª¢æŸ¥ä¿è­·æ©Ÿåˆ¶ç‹€æ…‹å¤±æ•—: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>
